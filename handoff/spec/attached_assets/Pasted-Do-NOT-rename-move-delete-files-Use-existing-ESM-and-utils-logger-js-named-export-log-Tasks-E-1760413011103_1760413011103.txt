Do NOT rename/move/delete files. Use existing ESM and utils/logger.js (named export log).

Tasks / Edits:

Create routes/plan.js (ESM, full content):

// routes/plan.js
import express from 'express';
import { log } from '../utils/logger.js';

const router = express.Router();

/**
 * POST /plan
 * Stub OpenAI plan: validates input and returns a strict-schema JSON plan.
 * No external calls.
 */
router.post('/', (req, res) => {
  const { photo_url, prompt, measurements } = req.body || {};

  const missing = [];
  if (!photo_url || typeof photo_url !== 'string') missing.push('photo_url');
  if (!prompt || typeof prompt !== 'string') missing.push('prompt');
  if (missing.length) {
    log('plan_validation_error', { route: '/plan', missing });
    return res.status(400).json({ ok: false, error: 'invalid_payload', fields_missing: missing });
  }

  // Deterministic variants based on prompt length
  const n = prompt.length % 3; // 0,1,2
  const style = ['modern', 'coastal', 'farmhouse'][n];
  const wood = ['birch', 'oak', 'maple'][n];
  const finish = ['matte black', 'brushed nickel', 'white'][n];

  const m = (measurements && typeof measurements === 'object') ? measurements : {};
  const width_in = Number(m.width_in || 72);
  const depth_in = Number(m.depth_in || 10);

  const materials = [
    { name: `${wood} plywood 3/4" (4x8)`, qty: 1, unit: 'sheet', unit_price: 68.0, subtotal: 68.0, notes: 'Cut to shelf pieces' },
    { name: 'Edge banding 3/4"', qty: Math.ceil(width_in / 96), unit: 'ea', unit_price: 7.5, subtotal: Math.ceil(width_in / 96) * 7.5 },
    { name: `${finish} L-brackets`, qty: 4, unit: 'ea', unit_price: 9.0, subtotal: 36.0, notes: 'Two per shelf' },
    { name: 'Wood screws #8 x 1-1/4"', qty: 1, unit: 'lb', unit_price: 6.0, subtotal: 6.0 },
    { name: 'Wall anchors', qty: 8, unit: 'ea', unit_price: 0.6, subtotal: 4.8 }
  ];

  const tools = [
    { name: 'Drill/driver', have: true,  rent_price: 0,  buy_price: 89 },
    { name: 'Stud finder',  have: false, rent_price: 8,  buy_price: 22 },
    { name: 'Level (24")',  have: false, rent_price: 6,  buy_price: 15 }
  ];

  const cut_list = [
    { item: 'Shelf', dimensions: `${width_in}" x ${depth_in}" x 3/4"`, qty: 2, notes: `${wood}` },
  ];

  const steps = [
    { n: 1, title: 'Plan & mark studs', details: 'Locate studs, mark shelf height and bracket positions.', duration_min: 15, depends_on: [] },
    { n: 2, title: 'Cut shelves', details: `Cut ${wood} plywood to size; apply edge banding.`, duration_min: 30, depends_on: [1] },
    { n: 3, title: 'Pre-drill brackets', details: `Pre-drill ${finish} brackets and shelf underside.`, duration_min: 20, depends_on: [2] },
    { n: 4, title: 'Mount brackets', details: 'Level and fasten brackets into studs/anchors.', duration_min: 25, depends_on: [3] },
    { n: 5, title: 'Install shelves', details: 'Place shelves and secure with screws; final check.', duration_min: 20, depends_on: [4] }
  ];

  const safety = [
    'Wear eye and hearing protection.',
    'Use anchors appropriate for your wall type.',
    'Confirm no electrical/plumbing behind drill points.'
  ];

  const materials_total = Number(materials.reduce((s, it) => s + (Number(it.subtotal) || 0), 0).toFixed(2));
  const tools_total = Number(
    tools.reduce((s, t) => s + (t.have ? 0 : Math.min(t.rent_price || 0, t.buy_price || 0)), 0).toFixed(2)
  );
  const contingency_pct = 0.12;
  const grand_total = Number(((materials_total + tools_total) * (1 + contingency_pct)).toFixed(2));

  const plan = {
    overview: `${style} floating shelves plan generated from prompt.`,
    assumptions: [
      'Wall is plumb with accessible studs or solid anchors.',
      `Target width ~${width_in}" and depth ~${depth_in}".`,
      'Basic DIY tools available; renting optional tools as needed.'
    ],
    materials,
    tools,
    cut_list,
    steps,
    safety,
    estimation: { materials_total, tools_total, contingency_pct, grand_total }
  };

  log('plan_stub_generate', { route: '/plan', source: 'stub|openai', style });
  return res.status(200).json({ ok: true, source: 'stub|openai', plan });
});

export default router;


Mount in index.js (minimal diff):

@@
 import express from 'express';
 const app = express();
 app.use(express.json());

 import previewRoute from './routes/preview.js';
 app.use('/preview', previewRoute);
 
+import planRoute from './routes/plan.js';
+app.use('/plan', planRoute);